---
title: "BigQuery-Lecture 1"
author: "Jae Jung"
date: today
format: 
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    toc-location: right-body
    number-sections: true
    code-line-numbers: true
    code-block-bg: true
    code-block-border-left: "#31BAE9"
    embed-resources: true
editor: visual
execute: 
  freeze: auto
---

# SELECT / FROM / LIMIT

::: callout-tip
**What it does**: picks columns from a table and returns rows.
:::

## Sample Query

``` sql
SELECT event_date, event_name
FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
LIMIT 1000;
```

## Output

![](images/paste-3.png)

# WHERE filters rows

::: callout-note
**What it does**: keeps only rows that match conditions.
:::

## Sample Query

> Task: Produce all the users who purchased on an event date

``` sql
SELECT event_date, event_name, user_pseudo_id
FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
WHERE event_name = 'purchase' 
LIMIT 100;
```

## Output

![](images/paste-4.png)

# ORDER BY sorts results

::: callout-tip
**What it does**: sorts rows ascending/descending
:::

## Sample Query 1

> Purchases and dates in the order of recency from most recent to oldest event.

``` sql
SELECT event_date, event_timestamp, event_name
FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
WHERE event_name = 'purchase'
ORDER BY event_timestamp DESC
LIMIT 20;
```

## Output 1

![](images/paste-5.png)

## Sample Query 2

::: callout-important
**Tip for readability**: GA4 timestamps are microseconds
:::

> **Task**: List all the events and associated time in descending order.

``` sql
SELECT 
  TIMESTAMP_MICROS(event_timestamp) AS event_time,
  event_name
FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
ORDER BY event_timestamp DESC
LIMIT 10;
```

## Output 2

![](images/paste-6.png)

# COUNT, SUM, AVG, MIN, MAX

::: callout-tip
**What they do**: summarize many rows into a few values.
:::

## Sample Query 1

> **Task:** Count total events in a date range. That is, what is the number of events in the month of December 2020?

``` sql
SELECT COUNT(*) AS event_count
FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
WHERE _TABLE_SUFFIX BETWEEN '20201201' AND '20201231';
```

## Output 1

![](images/paste-7.png)

## Sample Query 2

> **Task**: Count purchases in a date range

``` sql
SELECT COUNT(*) AS purchase_events
FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
WHERE event_name = 'purchase'
    AND _TABLE_SUFFIX BETWEEN '20201201' AND '20201231';
```

> **Task**: What is the number of all the purchases made during December 2020.

## Output 2

![](images/paste-8.png)

# GROUP BY controls the grain

::: callout-note
**What it does**: defines what one row in your result represents (e.g., per day, per event_name, per user).
:::

## Sample Query 1

> **Task**: List event date and event counts by event date in ascending order for December 2020.

``` sql
-- Events by day
SELECT event_date, COUNT(*) AS events
FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
WHERE _TABLE_SUFFIX BETWEEN '20201201' AND '20201231'
GROUP BY event_date
ORDER BY event_date;
```

## Output 1

![](images/paste-9.png)

## Sample Query 2

> **Task**: List top 15 event names and their counts by the event counts.

``` sql
-- Top event types
SELECT event_name, COUNT(*) AS events
FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
WHERE _TABLE_SUFFIX BETWEEN '20201201' AND '20201231'
GROUP BY event_name
ORDER BY events DESC
LIMIT 15;
```

## Output 2

![](images/paste-10.png)

# HAVING filters after grouping

::: callout-tip
**What it does**: filters aggregated results (after GROUP BY).
:::

## Sample Query

> **Task**: List all the events and associated event counts greater than 50,000 in descending order of event counts.

``` sql
-- Only event types with at least 50,000 events
SELECT event_name, COUNT(*) AS events
FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
WHERE _TABLE_SUFFIX BETWEEN '20201201' AND '20201231'
GROUP BY event_name
HAVING COUNT(*) >= 50000
ORDER BY events DESC;
```

## Output

![](images/paste-11.png)

# Wildcard tables + \_TABLE_SUFFIX

::: callout-note
**What it does**: events\_\* queries many days, and \_TABLE_SUFFIX limits which days you scan (faster/cheaper).
:::

## Query

> **Task**: Event counts by event date for the first 7 days of December, 2020.

``` sql
SELECT event_date, COUNT(*) AS events
FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
WHERE _TABLE_SUFFIX BETWEEN '20201201' AND '20201207'
GROUP BY event_date
ORDER BY event_date;
```

## Output

![](images/paste-12.png)